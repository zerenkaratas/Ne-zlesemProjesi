import { useEffect, useMemo, useState, useRef } from "react";
import { useNavigate } from "react-router-dom";
import api from "../api/axios";
import { getToken, logout } from "../utils/auth";
import { getMe } from "../api/auth";
import { theme } from "../ui/theme";

type Kind = "ALL" | "MOVIE" | "SERIES";
type ListType = "WATCHED" | "CONTINUE" | "WISHLIST";

type Title = {
  id: string;
  name: string;
  kind: "MOVIE" | "SERIES";
  posterUrl?: string;
  description?: string;
};

type ListItem = {
  id: string;
  title: Title;
  createdAt: string;
};

type UserList = {
  id: string;
  type: ListType;
  items: ListItem[];
  createdAt: string;
};

function kindLabel(kind: Kind) {
  if (kind === "MOVIE") return "Film";
  if (kind === "SERIES") return "Dizi";
  return "Film+Dizi";
}

function listLabel(t: ListType) {
  if (t === "WATCHED") return "Ä°zlediklerim";
  if (t === "CONTINUE") return "Ä°zlemeye Devam";
  return "Ä°stek Listem";
}

export default function Home() {
  const navigate = useNavigate();

  const [kind, setKind] = useState<Kind>("MOVIE");
  const [titles, setTitles] = useState<Title[]>([]);
  const [lists, setLists] = useState<UserList[]>([]);
  const [selected, setSelected] = useState<Title | null>(null);

  const [me, setMe] = useState<{
    userId: string;
    username: string;
    firstName?: string;
    lastName?: string;
    avatar?: 'male' | 'female';
    role: string;
  } | null>(null);

  const [loadingTitles, setLoadingTitles] = useState(false);
  const [loadingLists, setLoadingLists] = useState(false);
  const [info, setInfo] = useState<string | null>(null);
  const [filterWatched, setFilterWatched] = useState(false);
  const [filterCont, setFilterCont] = useState(false);
  const [filterWish, setFilterWish] = useState(false);
  const [isSpinning, setIsSpinning] = useState(false);
  const wheelRef = useRef<HTMLDivElement>(null);

  // ğŸ” login kontrolÃ¼
  useEffect(() => {
    const token = getToken();
    if (!token) {
      navigate("/login");
      return;
    }

    (async () => {
      try {
        const mod = await import("../utils/auth");
        const cached = mod.getProfile();
        if (cached) {
          setMe(cached);
        } else {
          const data = await getMe(token);
          setMe(data);
        }
      } catch (e) {
        try {
          const data = await getMe(token);
          setMe(data);
        } catch (err) {
          logout();
          navigate("/login");
        }
      }
    })();
  }, [navigate]);

  function authHeaders() {
    const token = getToken();
    return token ? { Authorization: `Bearer ${token}` } : {};
  }

  async function loadTitles(k: Kind) {
    setLoadingTitles(true);
    setInfo(null);
    try {
      const res = await api.get(`/titles?kind=${k}`);
      setTitles(res.data);
    } catch (e: any) {
      setInfo(e?.response?.data?.message ?? "BaÅŸlÄ±klar alÄ±namadÄ±.");
    } finally {
      setLoadingTitles(false);
    }
  }

  async function loadLists(k: Kind) {
    setLoadingLists(true);
    setInfo(null);
    try {
      const res = await api.get(`/lists?kind=${k}`, { headers: authHeaders() });
      setLists(res.data);
    } catch (e: any) {
      setInfo(e?.response?.data?.message ?? "Listeler alÄ±namadÄ±.");
    } finally {
      setLoadingLists(false);
    }
  }

  // filtre deÄŸiÅŸince verileri Ã§ek
  useEffect(() => {
    loadTitles(kind);
    loadLists(kind);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [kind]);

  // sol panel iÃ§in listeleri ayÄ±r
  const watched = useMemo(() => lists.find((l) => l.type === "WATCHED"), [lists]);
  const cont = useMemo(() => lists.find((l) => l.type === "CONTINUE"), [lists]);
  const wish = useMemo(() => lists.find((l) => l.type === "WISHLIST"), [lists]);

  function spin() {
    setInfo(null);
    if (kind === "ALL") {
      setInfo("LÃ¼tfen Ã¶nce Film veya Dizi seÃ§in.");
      return;
    }

    // start with titles (already filtered by primary kind)
    let pool = Array.isArray(titles) ? titles.slice() : [];

    // if any secondary filters selected, intersect with user's list items
    if (filterWatched || filterCont || filterWish) {
      const union = new Set<string>();
      if (filterWatched && watched) {
        (watched.items || []).forEach(i => union.add(i.title.id));
      }
      if (filterCont && cont) {
        (cont.items || []).forEach(i => union.add(i.title.id));
      }
      if (filterWish && wish) {
        (wish.items || []).forEach(i => union.add(i.title.id));
      }
      pool = pool.filter(t => union.has(t.id));
    }

    if (!pool || pool.length === 0) {
      setInfo("Bu filtreleme ile eÅŸleÅŸen iÃ§erik yok.");
      return;
    }

    const selected = pool[Math.floor(Math.random() * pool.length)];
    
    // Spin animation
    setIsSpinning(true);
    const spins = 8 + Math.random() * 4; // 8-12 spins
    const rotation = spins * 360 + (pool.indexOf(selected) / pool.length) * 360;
    
    if (wheelRef.current) {
      wheelRef.current.style.transform = `rotate(${rotation}deg)`;
    }
    
    setTimeout(() => {
      setSelected(selected);
      setIsSpinning(false);
    }, 2000);
  }

  async function addTo(type: ListType) {
    setInfo(null);
    if (!selected) return;

    try {
      await api.post(
        `/lists/${type}/add`,
        { titleId: selected.id },
        { headers: authHeaders() }
      );
      setInfo(`âœ… "${selected.name}" â†’ ${listLabel(type)} listesine eklendi.`);
      await loadLists(kind);
    } catch (e: any) {
      setInfo(e?.response?.data?.message ?? "Listeye eklenemedi.");
    }
  }

  function handleLogout() {
    logout();
    navigate("/login");
  }

  const styles = {
    page: {
      minHeight: "100vh",
      display: "flex",
      flexDirection: "column" as const,
      background: theme.bg,
      color: theme.text,
      fontFamily: "system-ui, -apple-system, Segoe UI, Roboto, Arial",
    } as const,
    content: { display: 'flex', flex: 1 },
    sidebar: {
      width: 320,
      padding: 18,
      borderRight: "1px solid rgba(255,255,255,0.08)",
      background: "linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02))",
      backdropFilter: "blur(10px)",
    } as const,
    card: {
      border: "1px solid rgba(255,255,255,0.10)",
      borderRadius: 16,
      padding: 14,
      background: "rgba(255,255,255,0.05)",
      boxShadow: "0 12px 30px rgba(0,0,0,0.35)",
    } as const,
    pillRow: { display: "flex", gap: 8, flexWrap: "wrap" as const },
    pill: (active: boolean) =>
      ({
        padding: "8px 12px",
        borderRadius: 999,
        border: `1px solid ${active ? "rgba(193,122,255,0.8)" : "rgba(255,255,255,0.12)"}`,
        background: active ? "rgba(193,122,255,0.18)" : "rgba(255,255,255,0.04)",
        color: "#f4f1ff",
        cursor: "pointer",
      } as const),
    main: { flex: 1, padding: 22 } as const,
    header: {
      padding: '14px 22px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'space-between',
      gap: 12,
      borderBottom: `1px solid ${theme.border}`,
      background: 'transparent',
    } as const,
    profileCircle: {
      width: 48,
      height: 48,
      borderRadius: 999,
      display: 'grid',
      placeItems: 'center',
      background: 'rgba(255,255,255,0.04)',
      border: `1px solid ${theme.border}`,
    } as const,
    profileName: { fontSize: 14, fontWeight: 700 } as const,
    h1: { fontSize: 28, margin: 0, letterSpacing: 0.2 } as const,
    h2: { fontSize: 18, margin: "14px 0 10px" } as const,
    small: { opacity: 0.8, fontSize: 13 } as const,
    btn: {
      padding: "10px 12px",
      borderRadius: 12,
      border: "1px solid rgba(255,255,255,0.12)",
      background: "rgba(255,255,255,0.06)",
      color: "#f4f1ff",
      cursor: "pointer",
    } as const,
    primaryBtn: {
      padding: "12px 14px",
      borderRadius: 14,
      border: "1px solid rgba(193,122,255,0.65)",
      background: "linear-gradient(180deg, rgba(193,122,255,0.35), rgba(136,84,255,0.18))",
      color: "#fff",
      cursor: "pointer",
      boxShadow: "0 12px 30px rgba(160, 90, 255, 0.18)",
    } as const,
    listItemBtn: {
      width: "100%",
      textAlign: "left" as const,
      padding: "10px 10px",
      borderRadius: 12,
      border: "1px solid rgba(255,255,255,0.10)",
      background: "rgba(0,0,0,0.10)",
      color: "#f4f1ff",
      cursor: "pointer",
    } as const,
  };

  return (
    <div style={styles.page}>
      {/* HEADER */}
      <div style={styles.header}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <div style={{ fontSize: 20 }}>ğŸ¡</div>
          <div>
            <div style={{ fontWeight: 800, fontSize: 18 }}>Ne Ä°zlesem?</div>
            <div style={{ color: theme.muted, fontSize: 12 }}>{kindLabel(kind)}</div>
          </div>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          {me && (
            <>
              <div style={{ textAlign: 'right', marginRight: 8 }}>
                <div style={styles.profileName}>{me.firstName ? `${me.firstName} ${me.lastName || ''}` : me.username}</div>
                <div style={{ fontSize: 12, color: theme.muted }}>{me.role}</div>
              </div>
              <div style={styles.profileCircle} title={me.username}>
                <div style={{ fontSize: 20 }}>{me.avatar === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'}</div>
              </div>
            </>
          )}
        </div>
      </div>

      <div style={styles.content}>
      {/* SOL PANEL */}
      <aside style={styles.sidebar}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", gap: 10 }}>
          <div>
            <h3 style={styles.h1}>Listeler</h3>
            <div style={styles.small}>Filtre: <b>{kindLabel(kind)}</b></div>
          </div>
          <button style={styles.btn} onClick={() => navigate("/mode")}>Mod</button>
        </div>

        <div style={{ marginTop: 14, ...styles.card }}>
          <div style={{ fontWeight: 700, marginBottom: 10 }}>Filtre</div>
          <div style={styles.pillRow}>
            <button style={styles.pill(kind === "ALL")} onClick={() => setKind("ALL")}>Film+Dizi</button>
            <button style={styles.pill(kind === "MOVIE")} onClick={() => setKind("MOVIE")}>Film</button>
            <button style={styles.pill(kind === "SERIES")} onClick={() => setKind("SERIES")}>Dizi</button>
          </div>
          <div style={{ marginTop: 12, display: 'flex', gap: 8, alignItems: 'center' }}>
            <label style={{ display: 'flex', gap: 8, alignItems: 'center', color: theme.muted, fontSize: 13 }}>
              <input type="checkbox" checked={filterWatched} onChange={(e) => setFilterWatched(e.target.checked)} />
              Ä°zlediklerim
            </label>
            <label style={{ display: 'flex', gap: 8, alignItems: 'center', color: theme.muted, fontSize: 13 }}>
              <input type="checkbox" checked={filterCont} onChange={(e) => setFilterCont(e.target.checked)} />
              Ä°zlemeye Devam
            </label>
            <label style={{ display: 'flex', gap: 8, alignItems: 'center', color: theme.muted, fontSize: 13 }}>
              <input type="checkbox" checked={filterWish} onChange={(e) => setFilterWish(e.target.checked)} />
              Ä°zleyeceklerim
            </label>
          </div>
        </div>

        <div style={{ marginTop: 14, ...styles.card }}>
          <div style={{ display: "flex", justifyContent: "space-between" }}>
            <div style={{ fontWeight: 700 }}>Ä°zlediklerim</div>
            <div style={styles.small}>{watched?.items?.length ?? 0}</div>
          </div>
          <div style={{ marginTop: 10, display: "grid", gap: 8 }}>
            {(watched?.items ?? []).slice(0, 6).map((it) => (
              <button
                key={it.id}
                style={styles.listItemBtn}
                onClick={() => setSelected(it.title)}
                title="SeÃ§"
              >
                {it.title.kind === "MOVIE" ? "ğŸ¬" : "ğŸ“º"} {it.title.name}
              </button>
            ))}
            {(watched?.items?.length ?? 0) > 6 && (
              <div style={styles.small}>+{(watched!.items.length - 6)} dahaâ€¦</div>
            )}
          </div>
        </div>

        <div style={{ marginTop: 14, ...styles.card }}>
          <div style={{ display: "flex", justifyContent: "space-between" }}>
            <div style={{ fontWeight: 700 }}>Ä°zlemeye Devam Ettiklerim</div>
            <div style={styles.small}>{cont?.items?.length ?? 0}</div>
          </div>
          <div style={{ marginTop: 10, display: "grid", gap: 8 }}>
            {(cont?.items ?? []).slice(0, 6).map((it) => (
              <button
                key={it.id}
                style={styles.listItemBtn}
                onClick={() => setSelected(it.title)}
                title="SeÃ§"
              >
                {it.title.kind === "MOVIE" ? "ğŸ¬" : "ğŸ“º"} {it.title.name}
              </button>
            ))}
            {(cont?.items?.length ?? 0) > 6 && (
              <div style={styles.small}>+{(cont!.items.length - 6)} dahaâ€¦</div>
            )}
          </div>
        </div>

        <div style={{ marginTop: 14, ...styles.card }}>
          <div style={{ display: "flex", justifyContent: "space-between" }}>
            <div style={{ fontWeight: 700 }}>Ä°zleyeceklerim</div>
            <div style={styles.small}>{wish?.items?.length ?? 0}</div>
          </div>
          <div style={{ marginTop: 10, display: "grid", gap: 8 }}>
            {(wish?.items ?? []).slice(0, 6).map((it) => (
              <button
                key={it.id}
                style={styles.listItemBtn}
                onClick={() => setSelected(it.title)}
                title="SeÃ§"
              >
                {it.title.kind === "MOVIE" ? "ğŸ¬" : "ğŸ“º"} {it.title.name}
              </button>
            ))}
            {(wish?.items?.length ?? 0) > 6 && (
              <div style={styles.small}>+{(wish!.items.length - 6)} dahaâ€¦</div>
            )}
          </div>
        </div>

        <div style={{ marginTop: 14, display: "grid", gap: 10 }}>
          <button style={styles.btn} onClick={handleLogout}>Ã‡Ä±kÄ±ÅŸ Yap</button>
          {(loadingLists || loadingTitles) && (
            <div style={styles.small}>YÃ¼kleniyorâ€¦</div>
          )}
        </div>
      </aside>

      {/* ANA ALAN */}
      <main style={styles.main}>
        <div style={{ display: "flex", alignItems: "end", justifyContent: "space-between", gap: 12 }}>
          <div>
            <h1 style={styles.h1}>ğŸ¡ Ne Ä°zlesem?</h1>
            <div style={styles.h1}>
              Ã‡arkÄ± Ã§evir, ne izleyeceÄŸini seÃ§!
            </div>
          </div>
          <button
            style={{ ...styles.primaryBtn, opacity: kind === 'ALL' ? 0.6 : 1, cursor: kind === 'ALL' ? 'not-allowed' : 'pointer' }}
            onClick={spin}
            disabled={kind === 'ALL'}
          >Ã‡arkÄ± Ã‡evir</button>
        </div>

        {info && (
          <div style={{ marginTop: 14, ...styles.card, borderColor: "rgba(193,122,255,0.25)" }}>
            {info}
          </div>
        )}

        <div style={{ marginTop: 16, display: "grid", gridTemplateColumns: "1.2fr 0.8fr", gap: 16 }}>
          {/* SeÃ§ilen kart */}
          <div style={{ ...styles.card, minHeight: 220 }}>
            <div style={{ fontSize: 14, opacity: 0.9 }}>
              SeÃ§ili filtre: <b>{kindLabel(kind)}</b> â€¢ Toplam iÃ§erik: <b>{titles.length}</b>
            </div>

            {!selected ? (
              <div style={{ marginTop: 22, opacity: 0.85 }}>
                Ã‡arkÄ± Ã§evir veya soldaki listelerden bir iÃ§erik seÃ§.
              </div>
            ) : (
              <div style={{ marginTop: 16 }}>
                <div style={{ fontSize: 24, fontWeight: 800, lineHeight: 1.2 }}>
                  {selected.name}
                </div>
                <div style={{ marginTop: 8, opacity: 0.9 }}>
                  {selected.kind === "MOVIE" ? "ğŸ¬ Film" : "ğŸ“º Dizi"}
                </div>

                {selected.description && (
                  <div style={{ marginTop: 10, opacity: 0.85 }}>
                    {selected.description}
                  </div>
                )}

                <div style={{ marginTop: 16, display: "flex", gap: 10, flexWrap: "wrap" }}>
                  <button style={styles.btn} onClick={() => addTo("WATCHED")}>Ä°zledimâ€™e ekle</button>
                  <button style={styles.btn} onClick={() => addTo("CONTINUE")}>Devamâ€™a ekle</button>
                  <button style={styles.btn} onClick={() => addTo("WISHLIST")}>Ä°stekâ€™e ekle</button>
                </div>
              </div>
            )}
          </div>

          {/* KÃ¼Ã§Ã¼k â€œÃ§arkâ€ alanÄ± */}
          <div style={{ ...styles.card, minHeight: 220 }}>
            <div style={{ fontWeight: 800 }}>HÄ±zlÄ± Ã‡ark</div>
            <div style={{ marginTop: 10, ...styles.small }}>
              â€œÃ‡arkÄ± Ã‡evirâ€ her basÄ±ÅŸta rastgele seÃ§im yapar.
            </div>

            <div
              style={{
                marginTop: 16,
                height: 120,
                borderRadius: 16,
                border: "1px dashed rgba(193,122,255,0.45)",
                background: "rgba(193,122,255,0.08)",
                display: "grid",
                placeItems: "center",
                textAlign: "center",
                padding: 12,
              }}
            >
              {!selected ? (
                <div style={{ opacity: 0.85 }}>HenÃ¼z seÃ§im yok</div>
              ) : (
                <div>
                  <div style={{ fontSize: 14, opacity: 0.9 }}>
                    {selected.kind === "MOVIE" ? "ğŸ¬ Film" : "ğŸ“º Dizi"}
                  </div>
                  <div style={{ fontWeight: 800, fontSize: 16 }}>{selected.name}</div>
                </div>
              )}
            </div>

            <button style={{ ...styles.primaryBtn, marginTop: 14, width: "100%" }} onClick={spin}>
              Ã‡evir
            </button>
          </div>
        </div>
      </main>
      </div>
    </div>
  );
}
